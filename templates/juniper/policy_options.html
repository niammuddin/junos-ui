{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-cogs"></i> Policy Options: {{ device.name }}
    </h2>
    <div>
        <a href="{{ url_for('juniper.device_status', device_id=device.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Kembali ke Status
        </a>
    </div>
</div>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ url_for('auth.dashboard') }}">Dashboard</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('juniper.devices') }}">Devices</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('juniper.device_status', device_id=device.id) }}">{{ device.name }}</a>
        </li>
        <li class="breadcrumb-item active">Policy Options</li>
    </ol>
</nav>

<!-- Last Updated -->
<div class="alert alert-info d-flex justify-content-between align-items-center">
    <div>
        <i class="fas fa-clock"></i> 
        <strong>Last Updated:</strong> {{ policy_data.last_updated }}
    </div>
    <button class="btn btn-sm btn-outline-info" onclick="refreshPolicyOptions()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>

<!-- Tabs Navigation -->
<ul class="nav nav-tabs mb-4" id="policyTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="prefix-tab" data-bs-toggle="tab" data-bs-target="#prefix" type="button" role="tab">
            <i class="fas fa-list"></i> Prefix Lists ({{ policy_data.prefix_lists|length }})
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="policy-tab" data-bs-toggle="tab" data-bs-target="#policy" type="button" role="tab">
            <i class="fas fa-project-diagram"></i> Policy Statements ({{ policy_data.policy_statements|length }})
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="community-tab" data-bs-toggle="tab" data-bs-target="#community" type="button" role="tab">
            <i class="fas fa-users"></i> Communities ({{ policy_data.communities|length }})
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="policyTabsContent">
    <!-- Prefix Lists Tab -->
    <div class="tab-pane fade show active" id="prefix" role="tabpanel">
        <div class="row">
            {% for prefix_list in policy_data.prefix_lists %}
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-list-alt"></i> {{ prefix_list.name }}
                        </h6>
                        <span class="badge bg-light text-dark">{{ prefix_list.prefixes|length }} prefixes</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless">
                                <tbody>
                                    {% for prefix in prefix_list.prefixes %}
                                    <tr>
                                        <td width="10%">
                                            <span class="badge bg-{% if ':' in prefix %}info{% else %}success{% endif %}">
                                                {% if ':' in prefix %}IPv6{% else %}IPv4{% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <code>{{ prefix }}</code>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Policy Statements Tab -->
    <div class="tab-pane fade" id="policy" role="tabpanel">
        {% if policy_data.policy_statements %}
        <div class="alert alert-light border d-flex justify-content-between align-items-center audit-hint">
            <div class="d-flex align-items-center gap-2">
                <i class="fas fa-clipboard-check text-primary"></i>
                <span>Semua policy statement ditampilkan penuh untuk memudahkan audit.</span>
            </div>
            <span class="badge bg-light text-primary border border-primary">Total: {{ policy_data.policy_statements|length }} policy</span>
        </div>

        <div class="row g-3 align-items-end mb-4 policy-search-controls">
            <div class="col-lg-4 col-md-6">
                <label for="policySearchInput" class="form-label mb-1">Filter Pencarian</label>
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="search" class="form-control" id="policySearchInput" placeholder="Cari policy, term, prefix list, atau aksi..." autocomplete="off">
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <label class="form-label mb-1 d-flex justify-content-between">
                    <span>Sortir Local Preference</span>
                    <small class="text-muted">klik untuk tinggi/rendah</small>
                </label>
                <div class="btn-group w-100 policy-sort-group" role="group" aria-label="Sort Local Preference">
                    <button type="button" class="btn btn-outline-secondary btn-sm policy-sort-btn" data-policy-sort="localPref" data-sort-direction="desc">
                        Tinggi <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-up-fill" viewBox="0 0 16 16">
  <path d="m7.247 4.86-4.796 5.481c-.566.647-.106 1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 0 0 0-1.506 0z"/>
</svg>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm policy-sort-btn" data-policy-sort="localPref" data-sort-direction="asc">
                        Rendah <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
  <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
</svg>
                    </button>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <label class="form-label mb-1 d-flex justify-content-between">
                    <span>Sortir Jumlah AS Path</span>
                    <small class="text-muted">berdasarkan hitungan prepend</small>
                </label>
                <div class="btn-group w-100 policy-sort-group" role="group" aria-label="Sort AS Path">
                    <button type="button" class="btn btn-outline-secondary btn-sm policy-sort-btn" data-policy-sort="asPath" data-sort-direction="desc">
                        Terbanyak <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-up-fill" viewBox="0 0 16 16">
  <path d="m7.247 4.86-4.796 5.481c-.566.647-.106 1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 0 0 0-1.506 0z"/>
</svg>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm policy-sort-btn" data-policy-sort="asPath" data-sort-direction="asc">
                        Tersedikit <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
  <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
</svg>
                    </button>
                </div>
            </div>
            <div class="col-12">
                <small class="text-muted">Klik tombol yang sama lagi untuk kembali ke urutan asli.</small>
            </div>
        </div>

        <div class="policy-statement-grid">
            <div id="policySearchEmpty" class="alert alert-warning d-none mb-3">
                <i class="fas fa-info-circle"></i> Tidak ada policy atau term yang cocok dengan kata kunci pencarian.
            </div>
            {% for policy in policy_data.policy_statements %}
            <div class="card policy-card mb-4"
                 data-original-order="{{ loop.index0 }}"
                 data-max-local-pref="{% if policy.max_local_preference is not none %}{{ policy.max_local_preference }}{% endif %}"
                 data-max-as-count="{% if policy.max_as_path_count is not none %}{{ policy.max_as_path_count }}{% endif %}">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-project-diagram text-white"></i>
                        <span class="fw-semibold policy-name">{{ policy.name }}</span>
                    </div>
                    <span class="badge bg-light text-dark">{{ policy.terms|length }} terms</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover align-middle mb-0 policy-term-table">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" style="width: 20%;">Term</th>
                                    <th scope="col" style="width: 45%;">Match Conditions</th>
                                    <th scope="col">Then Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for term in policy.terms %}
                                {% set term_local_pref = term.then.local_preference if term.then.local_preference is defined else none %}
                                {% set term_as_count = term.then.as_path_count if term.then.as_path_count is defined else none %}
                                <tr class="policy-term-row"
                                    data-original-order="{{ loop.index0 }}"
                                    data-local-pref="{% if term_local_pref is not none %}{{ term_local_pref }}{% endif %}"
                                    data-as-count="{% if term_as_count is not none %}{{ term_as_count }}{% endif %}">
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="fw-semibold term-name">{{ term.name }}</span>
                                            <span class="text-muted small">Term {{ loop.index }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <ul class="list-unstyled mb-0 small">
                                            {% if term.from and term.from.prefix_list %}
                                            <li>
                                                <span class="text-muted">Prefix Lists:</span>
                                                {% for pl in term.from.prefix_list %}
                                                <span class="badge bg-primary">{{ pl }}</span>
                                                {% endfor %}
                                            </li>
                                            {% endif %}
                                            {% if term.from and term.from.route_filter %}
                                            <li class="mt-1">
                                                <span class="text-muted">Route Filters:</span>
                                                {% for rf in term.from.route_filter %}
                                                <span class="badge bg-info text-dark">{{ rf.address }}{% if rf.exact %} (exact){% endif %}</span>
                                                {% endfor %}
                                            </li>
                                            {% endif %}
                                            {% if not term.from or (not term.from.prefix_list and not term.from.route_filter) %}
                                            <li class="text-muted fst-italic">Match all prefixes</li>
                                            {% endif %}
                                        </ul>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-wrap gap-2">
                                            {% if term.then.accept %}
                                            <span class="badge bg-success"><i class="fas fa-check"></i> Accept</span>
                                            {% elif term.then.reject %}
                                            <span class="badge bg-danger"><i class="fas fa-times"></i> Reject</span>
                                            {% endif %}
                                            {% if term_local_pref is not none %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-star"></i> Local Pref: {{ term_local_pref }}
                                            </span>
                                            {% endif %}
                                            {% if term.then.as_path_prepend %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-retweet"></i> AS Path: {{ term.then.as_path_prepend }}
                                            </span>
                                            {% if term_as_count is not none %}
                                            <span class="badge bg-primary">
                                                {{ term_as_count }}
                                            </span>
                                            {% endif %}
                                            {% endif %}
                                            {% if term.then.community_add %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-tag"></i> Add Community: {{ term.then.community_add }}
                                            </span>
                                            {% endif %}
                                            {% if not term.then and term.default_then and term.default_then.accept %}
                                            <span class="badge bg-success"><i class="fas fa-check"></i> Accept (default)</span>
                                            {% elif not term.then and term.default_then and term.default_then.reject %}
                                            <span class="badge bg-danger"><i class="fas fa-times"></i> Reject (default)</span>
                                            {% endif %}
                                            {% if not term.then and not term.default_then %}
                                            <span class="badge bg-light text-muted border">No explicit action</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-info-circle"></i> Tidak ada policy statement yang tersedia.
        </div>
        {% endif %}
    </div>

    <!-- Communities Tab -->
    <div class="tab-pane fade" id="community" role="tabpanel">
        <div class="row">
            {% for community in policy_data.communities %}
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-users"></i> {{ community.name }}
                        </h6>
                        <span class="badge bg-light text-dark">{{ community.members|length }} members</span>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2">
                            {% for member in community.members %}
                            <span class="badge bg-primary">{{ member }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshPolicyOptions() {
    if (!confirm('Refresh policy options configuration?')) return;
    
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    btn.disabled = true;
    
    setTimeout(() => {
        window.location.reload();
    }, 1000);
    
    setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }, 3000);
}

// Auto-switch tabs based on URL hash
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    if (hash) {
        const tabTrigger = document.querySelector(hash + '-tab');
        if (tabTrigger) {
            const tab = new bootstrap.Tab(tabTrigger);
            tab.show();
        }
    }
    
    // Update URL when tab changes
    const policyTabsEl = document.getElementById('policyTabs');
    if (policyTabsEl) {
        policyTabsEl.addEventListener('shown.bs.tab', function (e) {
            window.location.hash = e.target.getAttribute('data-bs-target').replace('#', '');
        });
    }

    const searchInput = document.getElementById('policySearchInput');
    const sortButtons = document.querySelectorAll('.policy-sort-btn');
    const policyCards = Array.from(document.querySelectorAll('#policy .policy-card'));
    const policyGrid = document.querySelector('#policy .policy-statement-grid');
    const emptyNotice = document.getElementById('policySearchEmpty');
    let activeSort = { key: null, direction: null };

    const parseNumber = (value) => {
        if (value === null || value === undefined || value === '') return null;
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
    };

    const applySort = () => {
        if (!policyGrid) return;
        const { key, direction } = activeSort;
        const sortedCards = policyCards.slice().sort((a, b) => {
            const orderA = parseNumber(a.dataset.originalOrder) ?? 0;
            const orderB = parseNumber(b.dataset.originalOrder) ?? 0;

            if (!key) {
                return orderA - orderB;
            }

            const valueA = key === 'localPref'
                ? parseNumber(a.dataset.maxLocalPref)
                : parseNumber(a.dataset.maxAsCount);
            const valueB = key === 'localPref'
                ? parseNumber(b.dataset.maxLocalPref)
                : parseNumber(b.dataset.maxAsCount);

            if (valueA === null && valueB === null) {
                return orderA - orderB;
            }
            if (valueA === null) return 1;
            if (valueB === null) return -1;
            if (valueA === valueB) {
                return orderA - orderB;
            }
            return direction === 'asc' ? valueA - valueB : valueB - valueA;
        });

        sortedCards.forEach(card => policyGrid.appendChild(card));
    };

    const setActiveSortButton = (button) => {
        sortButtons.forEach(btn => btn.classList.remove('active'));
        if (button) {
            button.classList.add('active');
        }
    };

    sortButtons.forEach(button => {
        button.addEventListener('click', () => {
            const key = button.dataset.policySort;
            const direction = button.dataset.sortDirection;
            const isActive = activeSort.key === key && activeSort.direction === direction;

            if (isActive) {
                activeSort = { key: null, direction: null };
                setActiveSortButton(null);
            } else {
                activeSort = { key, direction };
                setActiveSortButton(button);
            }

            applySort();
        });
    });

    const applyFilter = () => {
        const query = searchInput ? searchInput.value.trim().toLowerCase() : '';
        let visibleCount = 0;

        policyCards.forEach(card => {
            const policyNameEl = card.querySelector('.policy-name');
            const policyName = policyNameEl ? policyNameEl.textContent.trim().toLowerCase() : '';
            const termRows = Array.from(card.querySelectorAll('tbody .policy-term-row'));
            let anyVisibleTerm = false;

            termRows.forEach(row => {
                const matches = !query || row.textContent.toLowerCase().includes(query);
                row.classList.toggle('d-none', !!query && !matches);
                if (matches) {
                    anyVisibleTerm = true;
                }
            });

            if (query && policyName.includes(query)) {
                anyVisibleTerm = true;
                termRows.forEach(row => row.classList.remove('d-none'));
            }

            const shouldShow = !query || anyVisibleTerm;
            card.classList.toggle('d-none', !shouldShow);
            if (shouldShow) {
                visibleCount += 1;
            }
        });

        if (emptyNotice) {
            emptyNotice.classList.toggle('d-none', visibleCount > 0);
        }
    };

    if (searchInput) {
        searchInput.addEventListener('input', applyFilter);
    }

    if (policyTabsEl) {
        policyTabsEl.addEventListener('shown.bs.tab', function (e) {
            if (e.target.id === 'policy-tab') {
                applyFilter();
            }
        });
    }

    applyFilter();
    applySort();
});
</script>

<style>
.badge {
    font-size: 0.75rem;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
}

.audit-hint {
    font-size: 0.875rem;
}

.policy-card .card-header {
    border-bottom: none;
}

.policy-search-controls .input-group-text {
    background-color: #f8f9fa;
}

.policy-search-controls .form-control {
    box-shadow: none;
}

.policy-sort-group .btn {
    font-size: 0.8rem;
    white-space: nowrap;
}

.policy-sort-group .btn.active {
    background-color: #0d6efd;
    color: #fff;
    border-color: #0a58ca;
}

.policy-term-table th {
    font-size: 0.7rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: #6c757d;
}

.policy-term-table td {
    vertical-align: top;
    font-size: 0.85rem;
}

.policy-term-table .badge {
    font-size: 0.7rem;
}

.nav-tabs .nav-link {
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    font-weight: 600;
}
</style>
{% endblock %}
