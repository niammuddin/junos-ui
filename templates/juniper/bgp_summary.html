{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-project-diagram"></i> BGP Summary: {{ device.name }}</h2>
    <a href="{{ url_for('juniper.device_status', device_id=device.id) }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Kembali ke Status
    </a>
</div>

{% if bgp_data and not bgp_data.error %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <h3>{{ bgp_data.summary.peer_count }}</h3>
                <p class="mb-0">Total Peers</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h3>{{ bgp_data.summary.established_peer_count }}</h3>
                <p class="mb-0">Established</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body text-center">
                <h3>{{ bgp_data.summary.down_peer_count }}</h3>
                <p class="mb-0">Down</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <h3>{{ bgp_data.summary.group_count }}</h3>
                <p class="mb-0">Groups</p>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-dark text-white d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 peer-card-header">
        <h5 class="card-title mb-0"><i class="fas fa-network-wired"></i> BGP Peers ({{ bgp_data.peers|length }})</h5>
        <div class="peer-header-tools d-flex flex-column flex-md-row align-items-md-center gap-2 w-100 w-md-auto ms-md-auto">
            <div class="peer-filter-group">
                <button type="button" class="peer-filter-btn active" data-filter="all" onclick="filterPeers('all')">All</button>
                <button type="button" class="peer-filter-btn" data-filter="established" onclick="filterPeers('established')">Established</button>
                <button type="button" class="peer-filter-btn" data-filter="down" onclick="filterPeers('down')">Down</button>
            </div>
            <div class="input-group input-group-sm peer-search">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text"
                       class="form-control"
                       placeholder="Cari peer / AS / deskripsi"
                       aria-label="Cari peer"
                       oninput="searchPeers(this.value)">
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="15%">Peer Address</th>
                        <th width="8%">AS</th>
                        <th width="12%">State</th>
                        <th width="15%">Description</th>
                        <th width="10%">Messages</th>
                        <th width="8%">Flaps</th>
                        <th width="12%">Uptime</th>
                        <th width="10%">Prefixes</th>
                        <th width="10%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for peer in bgp_data.peers %}
                    <tr class="peer-row {% if peer.peer_state == 'Established' %}table-established{% else %}table-danger{% endif %}">
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-server text-muted me-2"></i>
                                <div>
                                    <strong>{{ peer.peer_address }}</strong>
                                    <br>
                                    {% if ':' in peer.peer_address %}
                                        <small class="text-muted">IPv6</small>
                                    {% else %}
                                        <small class="text-muted">IPv4</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td><strong>{{ peer.peer_as }}</strong></td>
                        <td>
                            <span class="badge bg-{% if peer.peer_state == 'Established' %}success{% else %}danger{% endif %}">
                                <i class="fas fa-{% if peer.peer_state == 'Established' %}check-circle{% else %}exclamation-circle{% endif %} me-1"></i>
                                {{ peer.peer_state }}
                            </span>
                        </td>
                        <td>
                            {% if peer.description %}
                                {{ peer.description }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="small">
                                <div class="text-success">
                                    <i class="fas fa-download me-1"></i>{{ peer.input_messages }}
                                </div>
                                <div class="text-primary">
                                    <i class="fas fa-upload me-1"></i>{{ peer.output_messages }}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if peer.flap_count == '0' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>{{ peer.flap_count }}
                                </span>
                            {% else %}
                                <span class="badge bg-warning" data-bs-toggle="tooltip" title="Peer pernah flapping">
                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ peer.flap_count }}
                                </span>
                            {% endif %}
                        </td>
                        <td>{{ peer.elapsed_time }}</td>
                        <td>
                            {% if peer.ribs %}
                                {% set rib = peer.ribs[0] %}
                                <div class="small">
                                    <div class="text-success"><i class="fas fa-check-circle me-1"></i>{{ rib.active_prefix_count }}</div>
                                    <div class="text-muted"><i class="fas fa-database me-1"></i>{{ rib.received_prefix_count }}</div>
                                </div>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('juniper.bgp_neighbor_detail', device_id=device.id, neighbor_address=peer.peer_address.split('+')[0]) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="View Detailed Info">
                                <i class="fas fa-search"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-info" onclick="refreshPeer({{ device.id }}, '{{ peer.peer_address }}', event)" data-bs-toggle="tooltip" title="Refresh Peer Status">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </td>
                    </tr>
                    {% if peer.ribs and peer.ribs|length > 1 %}
                    <tr class="bg-light peer-row">
                        <td colspan="9" class="p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted"><strong>Additional RIBs:</strong></small>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for rib in peer.ribs %}
                                    {% if loop.index > 1 %}
                                    <span class="badge bg-info small">
                                        {{ rib.name }}: <strong>{{ rib.active_prefix_count }}</strong>/{{ rib.received_prefix_count }}
                                    </span>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0"><i class="fas fa-chart-pie"></i> Connection Status</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-around text-center">
                    <div>
                        <h4 class="text-success">{{ bgp_data.summary.established_peer_count }}</h4>
                        <small class="text-muted">Established</small>
                    </div>
                    <div>
                        <h4 class="text-danger">{{ bgp_data.summary.down_peer_count }}</h4>
                        <small class="text-muted">Down</small>
                    </div>
                    <div>
                        <h4 class="text-primary">{{ bgp_data.peers|length }}</h4>
                        <small class="text-muted">Total</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h6 class="card-title mb-0"><i class="fas fa-exclamation-triangle"></i> Stability Overview</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-around text-center">
                    <div>
                        <h4 class="text-success">{{ bgp_data.peers|selectattr('flap_count', 'equalto', '0')|list|length }}</h4>
                        <small class="text-muted">Stable Peers</small>
                    </div>
                    <div>
                        <h4 class="text-warning">{{ bgp_data.peers|rejectattr('flap_count', 'equalto', '0')|list|length }}</h4>
                        <small class="text-muted">Flapping Peers</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if bgp_data.ribs %}
<div class="card">
    <div class="card-header bg-secondary text-white">
        <h5 class="card-title mb-0"><i class="fas fa-database"></i> BGP RIBs Summary</h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% for rib in bgp_data.ribs %}
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">{{ rib.name }}</h6>
                        <span class="badge bg-primary">Total: {{ rib.total_prefix_count }}</span>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <h5 class="text-success mb-0">{{ rib.active_prefix_count }}</h5>
                                    <small class="text-muted">Active</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <h5 class="text-info mb-0">{{ rib.received_prefix_count }}</h5>
                                    <small class="text-muted">Received</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <h5 class="text-warning mb-0">{{ rib.accepted_prefix_count }}</h5>
                                    <small class="text-muted">Accepted</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% elif bgp_error %}
<div class="alert alert-danger">
    <h5><i class="fas fa-exclamation-triangle"></i> Gagal mengambil data BGP</h5>
    <p class="mb-0">{{ bgp_error }}</p>
</div>
{% else %}
<div class="alert alert-info">
    <h5><i class="fas fa-sync-alt fa-spin"></i> Memuat data BGP...</h5>
    <p class="mb-0">Sedang mengambil informasi BGP dari device.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>

let currentPeerFilter = 'all';
let currentSearchTerm = '';

document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    setActivePeerFilter(currentPeerFilter);
});

function applyPeerFilters() {
    const rows = document.querySelectorAll('.peer-row');
    rows.forEach(row => {
        const matchesStatus =
            currentPeerFilter === 'all' ||
            (currentPeerFilter === 'established' && row.classList.contains('table-established')) ||
            (currentPeerFilter === 'down' && row.classList.contains('table-danger'));

        const rowText = row.innerText.toLowerCase();
        const matchesSearch = !currentSearchTerm || rowText.includes(currentSearchTerm);

        row.style.display = matchesStatus && matchesSearch ? '' : 'none';
    });
}

function filterPeers(status) {
    currentPeerFilter = status;
    applyPeerFilters();
    setActivePeerFilter(status);
}

function searchPeers(value) {
    currentSearchTerm = value.trim().toLowerCase();
    applyPeerFilters();
}

function setActivePeerFilter(status) {
    document.querySelectorAll('.peer-filter-btn').forEach(button => {
        button.classList.toggle('active', button.dataset.filter === status);
    });
}

function refreshPeer(deviceId, peerAddress, evt) {
    const button = evt.target.closest('button');
    if (!confirm(`Refresh status untuk peer ${peerAddress}?`)) return;

    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;

    const encodedPeerAddress = encodeURIComponent(peerAddress);
    fetch(`/juniper/api/refresh-peer/${deviceId}/${encodedPeerAddress}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(`✅ Peer ${peerAddress} berhasil di-refresh`);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                alert(`❌ Gagal refresh: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error: ' + error.message);
        })
        .finally(() => {
            setTimeout(() => {
                button.innerHTML = originalHtml;
                button.disabled = false;
            }, 2000);
        });
}
</script>

<style>
.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table td {
    vertical-align: middle;
    font-size: 0.9rem;
}

.badge {
    font-size: 0.75rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.peer-card-header {
    background-color: #1d1f24 !important;
}

.peer-header-tools {
    width: 100%;
    max-width: 540px;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.peer-filter-group {
    display: flex;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    background-color: #272b33;
    overflow: hidden;
}

.peer-filter-btn {
    flex: 1;
    border: none;
    background: transparent;
    color: #e0e0e0;
    font-size: 0.8rem;
    font-weight: 500;
    padding: 0.35rem 0.75rem;
    transition: background-color 0.15s ease, color 0.15s ease;
}

.peer-filter-btn + .peer-filter-btn {
    border-left: 1px solid rgba(255, 255, 255, 0.12);
}

.peer-filter-btn:hover {
    background-color: rgba(255, 255, 255, 0.08);
}

.peer-filter-btn.active {
    color: #ffffff;
    font-weight: 600;
}

.peer-filter-btn[data-filter="all"].active {
    background-color: #3a3f47;
}

.peer-filter-btn[data-filter="established"].active {
    background-color: #1f6f3f;
}

.peer-filter-btn[data-filter="down"].active {
    background-color: #86212f;
}

.peer-search {
    width: 100%;
}

.peer-search .input-group-text {
    background-color: #272b33;
    color: #bfc5d0;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-right: none;
}

.peer-search .form-control {
    background-color: #272b33;
    color: #f8f9fa;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-left: none;
}

.peer-search .form-control::placeholder {
    color: rgba(255, 255, 255, 0.55);
}

@media (min-width: 768px) {
    .peer-header-tools {
        flex-direction: row;
        align-items: center;
    }

    .peer-filter-group {
        margin-bottom: 0;
    }

    .peer-search {
        flex: 1;
        min-width: 260px;
    }
}
</style>
{% endblock %}
