{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-network-wired"></i> Interfaces: {{ device.name }}
    </h2>
    <div>
        <a href="{{ url_for('juniper.device_status', device_id=device.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Kembali ke Status
        </a>
    </div>
</div>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ url_for('auth.dashboard') }}">Dashboard</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('juniper.devices') }}">Devices</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('juniper.device_status', device_id=device.id) }}">{{ device.name }}</a>
        </li>
        <li class="breadcrumb-item active">Interfaces</li>
    </ol>
</nav>

<!-- Last Updated -->
<div class="alert alert-info d-flex justify-content-between align-items-center">
    <div>
        <i class="fas fa-clock"></i> 
        <strong>Last Updated:</strong> {{ interfaces_data.last_updated }}
    </div>
    <button class="btn btn-sm btn-outline-info" onclick="refreshInterfaces()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>

{% if interfaces_data.error %}
<div class="alert alert-danger">
    <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
    <p class="mb-0">{{ interfaces_data.error }}</p>
</div>
{% else %}

<!-- Search and Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <!-- Search Box -->
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Cari interface, description, atau IP address...">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Filter Options -->
            <div class="col-md-6">
                <div class="row">
                    <div class="col-4">
                        <select id="typeFilter" class="form-select" onchange="filterInterfaces()">
                            <option value="all">Semua Tipe</option>
                            <option value="Ethernet">Ethernet</option>
                            <option value="10GigEthernet">10GigE</option>
                            <option value="AggregatedEthernet">LAG</option>
                            <option value="Management">Management</option>
                            <option value="Loopback">Loopback</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <select id="statusFilter" class="form-select" onchange="filterInterfaces()">
                            <option value="all">Semua Status</option>
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <select id="familyFilter" class="form-select" onchange="filterInterfaces()">
                            <option value="all">Semua IP</option>
                            <option value="ipv4">IPv4</option>
                            <option value="ipv6">IPv6</option>
                            <option value="dual">Dual Stack</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Action Buttons -->
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="showAllInterfaces()">
                        <i class="fas fa-eye"></i> Tampilkan Semua
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="filterEnabledOnly()">
                        <i class="fas fa-check-circle"></i> Enabled Only
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="filterLAGOnly()">
                        <i class="fas fa-link"></i> LAG Only
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="filterDualStackOnly()">
                        <i class="fas fa-layer-group"></i> Dual Stack
                    </button>
                    <div class="ms-auto">
                        <span class="badge bg-secondary" id="totalCount">
                            {{ interfaces_data.interfaces|length }} interfaces
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Interfaces List -->
<div class="accordion" id="interfacesAccordion">
    {% for interface in interfaces_data.interfaces %}
    <div class="accordion-item interface-item"
         data-name="{{ interface.name }}"
         data-type="{{ interface.type }}"
         data-status="{% if interface.disabled %}disabled{% else %}enabled{% endif %}"
         data-description="{{ interface.description }}"
         data-family="{% if interface.units and (interface.units[0].family.inet and interface.units[0].family.inet6) %}dual{% elif interface.units and interface.units[0].family.inet6 %}ipv6{% elif interface.units and interface.units[0].family.inet %}ipv4{% else %}none{% endif %}">
        
        <h2 class="accordion-header" id="heading{{ loop.index }}">
            <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#collapse{{ loop.index }}"
                    aria-expanded="{{ 'true' if loop.first else 'false' }}"
                    aria-controls="collapse{{ loop.index }}">
                
                <div class="d-flex justify-content-between align-items-center w-100 me-3">
                    <div class="d-flex align-items-center">
                        <!-- Interface Icon -->
                        <i class="fas 
                            {% if interface.type == 'AggregatedEthernet' %}fa-link
                            {% elif interface.type == 'Management' %}fa-cog
                            {% elif interface.type == 'Loopback' %}fa-redo
                            {% else %}fa-network-wired
                            {% endif %} 
                            me-3 text-{% if interface.disabled %}secondary{% else %}primary{% endif %}">
                        </i>
                        
                        <div class="text-start">
                            <!-- Interface Name and Status -->
                            <div class="d-flex align-items-center">
                                <strong class="me-2 interface-name">{{ interface.name }}</strong>
                                {% if interface.disabled %}
                                <span class="badge bg-danger me-2">
                                    <i class="fas fa-ban"></i> Disabled
                                </span>
                                {% else %}
                                <span class="badge bg-success me-2">
                                    <i class="fas fa-check"></i> Enabled
                                </span>
                                {% endif %}
                                
                                <span class="badge bg-info me-2 interface-type">{{ interface.type }}</span>
                                
                                {% if interface.vlan_tagging %}
                                <span class="badge bg-warning me-2">
                                    <i class="fas fa-tag"></i> VLAN Tagging
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- Description -->
                            {% if interface.description %}
                            <div class="small text-muted interface-description">
                                {{ interface.description }}
                            </div>
                            {% endif %}
                            
                            <!-- Basic Info -->
                            <div class="small text-muted">
                                {% if interface.options.bundle %}
                                    <i class="fas fa-project-diagram"></i> Bundle: {{ interface.options.bundle }}
                                {% endif %}
                                {% if interface.units %}
                                    <span class="ms-2">
                                        <i class="fas fa-layer-group"></i> {{ interface.units|length }} unit(s)
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="text-end">
                        {% if interface.units %}
                            {% set unit = interface.units[0] %}
                            <div class="small">
                                {% if unit.family.inet %}
                                    <span class="badge bg-success me-1">IPv4: {{ unit.family.inet|length }}</span>
                                {% endif %}
                                {% if unit.family.inet6 %}
                                    <span class="badge bg-info me-1">IPv6: {{ unit.family.inet6|length }}</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </button>
        </h2>
        
        <div id="collapse{{ loop.index }}" 
             class="accordion-collapse collapse {% if loop.first %}show{% endif %}" 
             aria-labelledby="heading{{ loop.index }}"
             data-bs-parent="#interfacesAccordion">
            
            <div class="accordion-body">
                <!-- Interface Details -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle"></i> Interface Details</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <th width="40%">Name:</th>
                                <td><code>{{ interface.name }}</code></td>
                            </tr>
                            <tr>
                                <th>Type:</th>
                                <td>
                                    <span class="badge bg-info">{{ interface.type }}</span>
                                </td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td>
                                    {% if interface.disabled %}
                                    <span class="badge bg-danger">Disabled</span>
                                    {% else %}
                                    <span class="badge bg-success">Enabled</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if interface.description %}
                            <tr>
                                <th>Description:</th>
                                <td>{{ interface.description }}</td>
                            </tr>
                            {% endif %}
                            {% if interface.encapsulation %}
                            <tr>
                                <th>Encapsulation:</th>
                                <td><code>{{ interface.encapsulation }}</code></td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h6><i class="fas fa-cog"></i> Configuration</h6>
                        <table class="table table-sm table-borderless">
                            {% if interface.vlan_tagging %}
                            <tr>
                                <th width="40%">VLAN Tagging:</th>
                                <td><span class="badge bg-success">Enabled</span></td>
                            </tr>
                            {% endif %}
                            {% if interface.options.bundle %}
                            <tr>
                                <th>LAG Bundle:</th>
                                <td><code>{{ interface.options.bundle }}</code></td>
                            </tr>
                            {% endif %}
                            {% if interface.options.minimum_links %}
                            <tr>
                                <th>Minimum Links:</th>
                                <td>{{ interface.options.minimum_links }}</td>
                            </tr>
                            {% endif %}
                            {% if interface.options.lacp_active is defined %}
                            <tr>
                                <th>LACP:</th>
                                <td>
                                    <span class="badge bg-{% if interface.options.lacp_active %}success{% else %}warning{% endif %}">
                                        {{ 'Active' if interface.options.lacp_active else 'Passive' }}
                                    </span>
                                    {% if interface.options.lacp_periodic %}
                                    ({{ interface.options.lacp_periodic }})
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
                
                <!-- Interface Units -->
                {% if interface.units %}
                <h6><i class="fas fa-layer-group"></i> Interface Units ({{ interface.units|length }})</h6>
                <div class="row">
                    {% for unit in interface.units %}
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <strong>Unit {{ unit.name }}</strong>
                                {% if unit.disabled %}
                                <span class="badge bg-danger">Disabled</span>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                {% if unit.description %}
                                <p class="card-text">{{ unit.description }}</p>
                                {% endif %}
                                
                                {% if unit.vlan_id %}
                                <div class="mb-2">
                                    <strong>VLAN ID:</strong>
                                    <span class="badge bg-primary">{{ unit.vlan_id }}</span>
                                </div>
                                {% endif %}
                                
                                <!-- IPv4 Addresses -->
                                {% if unit.family.inet %}
                                <div class="mb-2">
                                    <strong>IPv4 Addresses:</strong>
                                    {% for address in unit.family.inet %}
                                    <div class="mt-1">
                                        <code class="bg-light p-1 rounded">{{ address }}</code>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <!-- IPv6 Addresses -->
                                {% if unit.family.inet6 %}
                                <div class="mb-2">
                                    <strong>IPv6 Addresses:</strong>
                                    {% for address in unit.family.inet6 %}
                                    <div class="mt-1">
                                        <code class="bg-light p-1 rounded">{{ address }}</code>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Empty State -->
{% if not interfaces_data.interfaces %}
<div class="alert alert-info">
    <h5><i class="fas fa-info-circle"></i> No Interfaces Found</h5>
    <p class="mb-0">Tidak ada interfaces yang dikonfigurasi pada device ini.</p>
</div>
{% endif %}

{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentSearch = '';
let currentType = 'all';
let currentStatus = 'all';
let currentFamily = 'all';

function filterInterfaces() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const familyFilter = document.getElementById('familyFilter').value;
    
    currentSearch = searchTerm;
    currentType = typeFilter;
    currentStatus = statusFilter;
    currentFamily = familyFilter;
    
    const interfaceItems = document.querySelectorAll('.interface-item');
    let visibleCount = 0;
    
    interfaceItems.forEach(item => {
        const name = item.getAttribute('data-name').toLowerCase();
        const type = item.getAttribute('data-type');
        const status = item.getAttribute('data-status');
        const description = item.getAttribute('data-description').toLowerCase();
        const family = item.getAttribute('data-family');
        
        const matchesSearch = searchTerm === '' || 
            name.includes(searchTerm) ||
            description.includes(searchTerm);
        
        const matchesType = typeFilter === 'all' || type === typeFilter;
        const matchesStatus = statusFilter === 'all' || status === statusFilter;
        const matchesFamily = familyFilter === 'all' || 
            (familyFilter === 'dual' && family === 'dual') ||
            (familyFilter === 'ipv4' && (family === 'ipv4' || family === 'dual')) ||
            (familyFilter === 'ipv6' && (family === 'ipv6' || family === 'dual')) ||
            (familyFilter === 'none' && family === 'none');
        
        if (matchesSearch && matchesType && matchesStatus && matchesFamily) {
            item.style.display = '';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // Update count badge
    document.getElementById('totalCount').textContent = `${visibleCount} interfaces`;
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    filterInterfaces();
}

function showAllInterfaces() {
    document.getElementById('searchInput').value = '';
    document.getElementById('typeFilter').value = 'all';
    document.getElementById('statusFilter').value = 'all';
    document.getElementById('familyFilter').value = 'all';
    filterInterfaces();
}

function filterEnabledOnly() {
    document.getElementById('statusFilter').value = 'enabled';
    filterInterfaces();
}

function filterLAGOnly() {
    document.getElementById('typeFilter').value = 'AggregatedEthernet';
    filterInterfaces();
}

function filterDualStackOnly() {
    document.getElementById('familyFilter').value = 'dual';
    filterInterfaces();
}

// Real-time search
document.getElementById('searchInput').addEventListener('input', filterInterfaces);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    filterInterfaces();
});

function refreshInterfaces() {
    if (!confirm('Refresh interfaces configuration?')) return;
    
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    btn.disabled = true;
    
    setTimeout(() => {
        window.location.reload();
    }, 1000);
    
    setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }, 3000);
}
</script>

<style>
.accordion-button {
    font-weight: 600;
    background-color: #f8f9fa;
}

.accordion-button:not(.collapsed) {
    background-color: #e3f2fd;
    color: #0d6efd;
}

.interface-item {
    margin-bottom: 0.5rem;
    border: 1px solid rgba(0, 0, 0, 0.125);
    border-radius: 0.375rem;
}

.badge {
    font-size: 0.7rem;
}

.table th {
    font-weight: 600;
    font-size: 0.85rem;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.input-group-text {
    background-color: #f8f9fa;
}
</style>
{% endblock %}