{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-route"></i> Static Routes: {{ device.name }}
    </h2>
    <div>
        <a href="{{ url_for('juniper.device_status', device_id=device.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Kembali ke Status
        </a>
    </div>
</div>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ url_for('auth.dashboard') }}">Dashboard</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('juniper.devices') }}">Devices</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('juniper.device_status', device_id=device.id) }}">{{ device.name }}</a>
        </li>
        <li class="breadcrumb-item active">Static Routes</li>
    </ol>
</nav>

{% if routes_data.error %}
<div class="alert alert-danger">
    <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
    <p class="mb-0">{{ routes_data.error }}</p>
</div>
{% else %}

<!-- Search and Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <!-- Search Box -->
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Cari destination, next hop, atau interface...">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Filter Options -->
            <div class="col-md-6">
                <div class="row">
                    <div class="col-4">
                        <select id="statusFilter" class="form-select" onchange="filterTable()">
                            <option value="all">Semua Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <select id="protocolFilter" class="form-select" onchange="filterTable()">
                            <option value="all">Semua Protocol</option>
                            <option value="Static">Static</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <select id="familyFilter" class="form-select" onchange="filterTable()">
                            <option value="all">Semua IP</option>
                            <option value="ipv4">IPv4</option>
                            <option value="ipv6">IPv6</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Action Buttons -->
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="showAllRoutes()">
                        <i class="fas fa-eye"></i> Tampilkan Semua
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="filterActiveOnly()">
                        <i class="fas fa-check-circle"></i> Active Only
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="filterIPv4Only()">
                        <i class="fas fa-network-wired"></i> IPv4 Only
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="filterIPv6Only()">
                        <i class="fas fa-globe"></i> IPv6 Only
                    </button>
                    <div class="ms-auto">
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshStaticRoutes()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Route Tables -->
{% for table in routes_data.route_tables %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-table"></i> Route Table: {{ table.table_name }}
            <span class="badge bg-light text-dark ms-2 route-count" id="count-{{ table.table_name }}">
                {{ table.routes|length }} routes
            </span>
        </h5>
        <div class="d-flex gap-3">
            <span class="badge bg-success">Active: {{ table.active_route_count }}</span>
            <span class="badge bg-secondary">Total: {{ table.total_route_count }}</span>
            <span class="badge bg-warning">Hidden: {{ table.hidden_route_count }}</span>
        </div>
    </div>
    
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="20%">Destination</th>
                        <th width="10%">Status</th>
                        <th width="10%">Protocol</th>
                        <th width="10%">Preference</th>
                        <th width="15%">Next Hop</th>
                        <th width="15%">Interface</th>
                        <th width="20%">Age</th>
                    </tr>
                </thead>
                <tbody id="table-{{ table.table_name }}">
                    {% for route in table.routes %}
                    <tr class="route-row" 
                        data-destination="{{ route.destination }}"
                        data-status="{% if route.is_active %}active{% else %}inactive{% endif %}"
                        data-protocol="{{ route.protocol }}"
                        data-family="{% if ':' in route.destination %}ipv6{% else %}ipv4{% endif %}"
                        data-next-hop="{{ route.next_hop.to }}"
                        data-interface="{{ route.next_hop.via }}">
                        <!-- Destination -->
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-{% if ':' in route.destination %}globe{% else %}network-wired{% endif %} me-2 text-muted"></i>
                                <div>
                                    <strong class="destination-text">{{ route.destination }}</strong>
                                    <!-- <br>
                                    <small class="text-muted">
                                        {% if ':' in route.destination %}IPv6{% else %}IPv4{% endif %}
                                    </small> -->
                                </div>
                            </div>
                        </td>
                        
                        <!-- Status -->
                        <td>
                            {% if route.is_active %}
                            <span class="badge bg-success status-badge">
                                <i class="fas fa-check-circle"></i> Active
                            </span>
                            {% else %}
                            <span class="badge bg-secondary status-badge">
                                <i class="fas fa-times-circle"></i> Inactive
                            </span>
                            {% endif %}
                        </td>
                        
                        <!-- Protocol -->
                        <td>
                            <span class="badge bg-info protocol-badge">{{ route.protocol }}</span>
                        </td>
                        
                        <!-- Preference -->
                        <td>
                            <span class="badge bg-dark">{{ route.preference }}</span>
                        </td>
                        
                        <!-- Next Hop -->
                        <td>
                            {% if route.next_hop.type %}
                                <span class="badge bg-{% if route.next_hop.type == 'Discard' %}warning{% else %}danger{% endif %} next-hop-text">
                                    {{ route.next_hop.type }}
                                </span>
                            {% elif route.next_hop.to and route.next_hop.to != 'N/A' %}
                                <code class="next-hop-text">{{ route.next_hop.to }}</code>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        
                        <!-- Interface -->
                        <td>
                            {% if route.next_hop.via and route.next_hop.via != 'N/A' %}
                                <code class="interface-text">{{ route.next_hop.via }}</code>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        
                        <!-- Age -->
                        <td>
                            <div class="small">
                                <div>{{ route.age }}</div>
                                <!-- <small class="text-muted">{{ route.age_seconds }} seconds</small> -->
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Table Summary -->
    <div class="card-footer bg-light">
        <div class="row text-center">
            <div class="col-3">
                <small class="text-muted">Destinations</small>
                <div class="fw-bold">{{ table.destination_count }}</div>
            </div>
            <div class="col-3">
                <small class="text-muted">Active</small>
                <div class="fw-bold text-success">{{ table.active_route_count }}</div>
            </div>
            <div class="col-3">
                <small class="text-muted">Holddown</small>
                <div class="fw-bold text-warning">{{ table.holddown_route_count }}</div>
            </div>
            <div class="col-3">
                <small class="text-muted">Hidden</small>
                <div class="fw-bold text-danger">{{ table.hidden_route_count }}</div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Empty State -->
{% if not routes_data.route_tables %}
<div class="alert alert-info">
    <h5><i class="fas fa-info-circle"></i> No Static Routes Found</h5>
    <p class="mb-0">Tidak ada static routes yang dikonfigurasi pada device ini.</p>
</div>
{% endif %}

{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentSearch = '';
let currentStatus = 'all';
let currentProtocol = 'all';
let currentFamily = 'all';

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const protocolFilter = document.getElementById('protocolFilter').value;
    const familyFilter = document.getElementById('familyFilter').value;
    
    currentSearch = searchTerm;
    currentStatus = statusFilter;
    currentProtocol = protocolFilter;
    currentFamily = familyFilter;
    
    // Filter each table
    document.querySelectorAll('[id^="table-"]').forEach(tableBody => {
        const rows = tableBody.querySelectorAll('.route-row');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const destination = row.getAttribute('data-destination').toLowerCase();
            const status = row.getAttribute('data-status');
            const protocol = row.getAttribute('data-protocol');
            const family = row.getAttribute('data-family');
            const nextHop = row.getAttribute('data-next-hop').toLowerCase();
            const interface = row.getAttribute('data-interface').toLowerCase();
            
            const matchesSearch = searchTerm === '' || 
                destination.includes(searchTerm) ||
                nextHop.includes(searchTerm) ||
                interface.includes(searchTerm);
            
            const matchesStatus = statusFilter === 'all' || status === statusFilter;
            const matchesProtocol = protocolFilter === 'all' || protocol === protocolFilter;
            const matchesFamily = familyFilter === 'all' || family === familyFilter;
            
            if (matchesSearch && matchesStatus && matchesProtocol && matchesFamily) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update count badge
        const tableName = tableBody.id.replace('table-', '');
        const countBadge = document.getElementById(`count-${tableName}`);
        if (countBadge) {
            countBadge.textContent = `${visibleCount} routes`;
        }
    });
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    filterTable();
}

function showAllRoutes() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    document.getElementById('protocolFilter').value = 'all';
    document.getElementById('familyFilter').value = 'all';
    filterTable();
}

function filterActiveOnly() {
    document.getElementById('statusFilter').value = 'active';
    filterTable();
}

function filterIPv4Only() {
    document.getElementById('familyFilter').value = 'ipv4';
    filterTable();
}

function filterIPv6Only() {
    document.getElementById('familyFilter').value = 'ipv6';
    filterTable();
}

// Real-time search
document.getElementById('searchInput').addEventListener('input', filterTable);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    filterTable();
});

function refreshStaticRoutes() {
    if (!confirm('Refresh static routes information?')) return;
    
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    btn.disabled = true;
    
    setTimeout(() => {
        window.location.reload();
    }, 1000);
    
    setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }, 3000);
}
</script>

<style>
.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.75rem;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
}

.input-group-text {
    background-color: #f8f9fa;
}

.route-row {
    transition: all 0.3s ease;
}

.route-row:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
}
</style>
{% endblock %}