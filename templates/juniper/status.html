{% extends "base.html" %}

{% block title %}Status {{ device.name }}{% endblock %}

{% block content %}
<style>
  .status-eyebrow { letter-spacing:.18em; text-transform:uppercase; font-size:.75rem; color:var(--bs-gray-600); font-weight:600; }
  .status-title { font-size:1.9rem; font-weight:700; }
  .status-chip { display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .9rem; border-radius:999px; background:var(--bs-gray-100); font-size:.82rem; color:var(--bs-gray-800); }
  .status-chip i { color:var(--bs-primary); }
  .nav-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:.9rem; }
  .nav-tile { border:1px solid #e5e7eb; border-radius:1rem; padding:1rem; text-decoration:none; color:inherit; background:#fff; transition:.2s; box-shadow:0 .75rem 1.5rem rgba(15,23,42,.05); }
  .nav-tile small { color:var(--bs-gray-600); display:block; margin-top:.15rem; }
  .nav-tile i { color:var(--bs-primary); }
  .nav-tile:hover { transform:translateY(-2px); border-color:var(--bs-primary); color:var(--bs-primary); }
  .snapshot-panel { border:1px solid #e5e7eb; border-radius:1rem; padding:1.25rem; background:#fff; height:100%; box-shadow:0 .85rem 1.7rem rgba(15,23,42,.04); }
  .info-label { font-size:.78rem; text-transform:uppercase; letter-spacing:.08em; color:var(--bs-gray-500); margin-bottom:.15rem; display:block; }
  .info-value { font-size:1rem; font-weight:600; }
  .info-box { padding:.95rem 1.1rem; border-radius:1rem; border:1px solid #eef1f7; background:#f8fafc; height:100%; }
  .route-chip { display:inline-flex; align-items:center; gap:.35rem; padding:.3rem .8rem; border-radius:999px; background:#f1f5f9; font-size:.78rem; color:#0f172a; font-weight:600; }
  .skeleton { position:relative; overflow:hidden; background:#edf1f4; border-radius:1rem; min-height:150px; }
  .skeleton::after { content:""; position:absolute; inset:0; transform:translateX(-100%);
    background: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,.65) 50%, rgba(255,255,255,0) 100%);
    animation: shimmer 1.4s infinite; }
  @keyframes shimmer { 100% { transform:translateX(100%); } }
</style>

<div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
  <div>
    <div class="status-eyebrow mb-1">Status Device</div>
    <div class="status-title d-flex align-items-center gap-3 flex-wrap mb-2">
      {{ device.name }}
      {% if device.description %}
        <span class="badge text-bg-light rounded-pill">{{ device.description }}</span>
      {% endif %}
    </div>
    <div class="d-flex flex-wrap gap-2">
      <span class="status-chip"><i class="fas fa-network-wired"></i>{{ device.ip_address }}</span>
      {% if device.api_port %}<span class="status-chip"><i class="fas fa-plug"></i>REST {{ device.api_port }}</span>{% endif %}
      {% if device.gnmi_port %}<span class="status-chip"><i class="fas fa-wave-square"></i>gNMI {{ device.gnmi_port }}</span>{% endif %}
    </div>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a href="{{ url_for('juniper.devices') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i>Kembali
    </a>
    <button class="btn btn-primary" id="btn-refresh">
      <span class="me-1"><i class="fas fa-rotate"></i></span>Muat ulang data
    </button>
  </div>
</div>

<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="nav-grid">
      <a class="nav-tile" href="{{ url_for('juniper.device_bgp_summary', device_id=device.id) }}">
        <span><i class="fas fa-project-diagram me-1"></i>BGP Summary</span>
        <small>Status peer & statistik sesi BGP</small>
      </a>
      <a class="nav-tile" href="{{ url_for('juniper.policy_options', device_id=device.id) }}">
        <span><i class="fas fa-cogs me-1"></i>Policy Options</span>
        <small>Prefix list & policy statement</small>
      </a>
      <a class="nav-tile" href="{{ url_for('juniper.static_routes', device_id=device.id) }}">
        <span><i class="fas fa-route me-1"></i>Static Routes</span>
        <small>Rute statik terkonfigurasi</small>
      </a>
      <a class="nav-tile" href="{{ url_for('juniper.interfaces', device_id=device.id) }}">
        <span><i class="fas fa-network-wired me-1"></i>Interfaces</span>
        <small>Daftar interface & status</small>
      </a>
      <a class="nav-tile" href="{{ url_for('juniper.interface_traffic', device_id=device.id) }}">
        <span><i class="fas fa-tachometer-alt me-1"></i>Live Traffic</span>
        <small>Streaming telemetry via gNMI</small>
      </a>
    </div>
  </div>
</div>

<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-4 align-items-stretch">
      <div class="col-lg-6">
        <div class="snapshot-panel">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <h5 class="mb-1">System Overview</h5>
              <!-- <small class="text-muted">Ditarik asinkron, halaman langsung tampil.</small> -->
            </div>
          </div>
          <div class="alert alert-warning d-none" role="alert" data-system-error></div>
          <div class="skeleton" data-system-skeleton></div>
          <div class="d-none" data-system-content></div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="snapshot-panel">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <h5 class="mb-1">Profil Koneksi</h5>
              <!-- <small class="text-muted">Data ini diambil langsung dari database.</small> -->
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="info-box">
                <span class="info-label">REST API</span>
                <div class="info-value">
                  {{ 'HTTPS' if device.api_use_ssl else 'HTTP' }} :{{ device.api_port or '-' }}
                  {% if device.api_use_ssl and not device.api_verify_ssl %}
                    <span class="badge text-bg-warning text-dark ms-1">Skip verify</span>
                  {% elif device.api_use_ssl %}
                    <span class="badge text-bg-success ms-1">Verified</span>
                  {% else %}
                    <span class="badge text-bg-danger ms-1">Unsecured</span>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-box">
                <span class="info-label">gNMI</span>
                <div class="info-value">
                  Port {{ device.gnmi_port or 9339 }} •
                  {% if device.gnmi_use_ssl %}
                    TLS {% if device.gnmi_verify_ssl %}(verify){% else %}(skip verify){% endif %}
                  {% else %}
                    Plaintext
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-box">
                <span class="info-label">Username</span>
                <div class="d-flex align-items-center gap-2">
                  <span class="info-value" id="user-text">{{ device.username }}</span>
                  <button class="btn btn-light btn-sm" data-copy="#user-text" data-bs-toggle="tooltip" data-bs-title="Salin username">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-box">
                <span class="info-label">Deskripsi</span>
                <div class="info-value">{{ device.description or '-' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <h5 class="mb-1"><i class="fas fa-server me-2 text-primary"></i>Route Engine</h5>
        <!-- <small class="text-muted">Data dimuat dari API backend tanpa menahan render halaman.</small> -->
      </div>
    </div>
    <div class="alert alert-warning d-none" role="alert" data-route-error></div>
    <div class="skeleton" style="min-height:220px;" data-route-skeleton></div>
    <div class="d-none" data-route-content></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function(){
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(function (tooltipTriggerEl) {
    new bootstrap.Tooltip(tooltipTriggerEl);
  });

  document.querySelectorAll('[data-copy]').forEach(function(btn){
    btn.addEventListener('click', function(){
      var target = document.querySelector(this.getAttribute('data-copy'));
      if (!target) return;
      var text = (target.innerText || target.textContent || '').trim();
      if (!text) return;
      navigator.clipboard.writeText(text).then(()=>{
        var original = this.innerHTML;
        this.innerHTML = '<i class="fas fa-check"></i>';
        this.classList.remove('btn-light');
        this.classList.add('btn-success');
        setTimeout(()=>{
          this.innerHTML = original;
          this.classList.remove('btn-success');
          this.classList.add('btn-light');
        }, 1000);
      });
    });
  });

  var statusEndpoint = {{ status_api | tojson }};
  var btnRefresh = document.getElementById('btn-refresh');
  var systemSkeleton = document.querySelector('[data-system-skeleton]');
  var systemContent = document.querySelector('[data-system-content]');
  var systemError = document.querySelector('[data-system-error]');
  var routeSkeleton = document.querySelector('[data-route-skeleton]');
  var routeContent = document.querySelector('[data-route-content]');
  var routeError = document.querySelector('[data-route-error]');

  function show(el){ el && el.classList.remove('d-none'); }
  function hide(el){ el && el.classList.add('d-none'); }

  function safeValue(value, fallback){
    return (value === null || value === undefined) ? fallback : value;
  }

  function escapeHtml(value){
    return String(safeValue(value, '-'))
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function setSystemLoading(){
    show(systemSkeleton);
    hide(systemContent);
    hide(systemError);
  }

  function setSystemError(message){
    hide(systemSkeleton);
    hide(systemContent);
    systemError.textContent = message || 'Data system tidak dapat dimuat.';
    show(systemError);
  }

  function setRouteLoading(){
    show(routeSkeleton);
    hide(routeContent);
    hide(routeError);
  }

  function setRouteError(message){
    hide(routeSkeleton);
    hide(routeContent);
    routeError.textContent = message || 'Data route engine tidak dapat dimuat.';
    show(routeError);
  }

  function renderInfoBox(label, value){
    return '<div class="col-md-6"><div class="info-box">'
      + '<span class="info-label">' + escapeHtml(label) + '</span>'
      + '<div class="info-value">' + escapeHtml(value) + '</div>'
      + '</div></div>';
  }

  function renderSystem(system){
    if (!system){
      setSystemError('Data system tidak tersedia.');
      return;
    }
    var rows = [
      renderInfoBox('Hostname', system.hostname || '-'),
      renderInfoBox('Model', system.model || '-'),
      renderInfoBox('OS Version', system.os_version || '-'),
      renderInfoBox('Serial Number', system.serial_number || '-')
    ];
    systemContent.innerHTML = '<div class="row g-3">' + rows.join('') + '</div>';
    hide(systemSkeleton);
    hide(systemError);
    show(systemContent);
  }

  function renderRoute(route){
    if (!route){
      setRouteError('Data route engine tidak tersedia.');
      return;
    }
    var statusText = route.status || 'Unknown';
    var normalized = statusText.toLowerCase();
    var statusClass = 'secondary';
    if (normalized.includes('ok') || normalized.includes('online')) statusClass = 'success';
    else if (normalized.includes('degrad') || normalized.includes('warn')) statusClass = 'warning';
    else if (normalized.includes('fail') || normalized.includes('down')) statusClass = 'danger';

    var cpu = route.cpu || {};
    var load = cpu.load_average || {};
    var memory = route.memory || {};
    var temp = route.temperature || {};
    var uptime = route.uptime || {};
    var userP = safeValue(cpu.user, 0);
    var sysP = safeValue(cpu.system, 0);
    var idleP = safeValue(cpu.idle, 0);
    var buf = safeValue(memory.buffer_utilization, 0);

    var html = ''
      + '<div class="d-flex flex-wrap align-items-center gap-2 mb-3">'
      + '<span class="route-chip text-' + statusClass + '"><i class="fas fa-circle"></i> ' + escapeHtml(statusText) + '</span>'
      + (uptime.up_time ? '<span class="route-chip"><i class="fas fa-clock"></i>' + escapeHtml(uptime.up_time) + '</span>' : '')
      + '</div>'
      + '<div class="row g-3">'
      + '<div class="col-md-6"><div class="info-box"><span class="info-label">Temperature</span><div class="info-value">'
      + escapeHtml(temp.text || '-')
      + (temp.celsius !== undefined && temp.celsius !== null ? '<small class="text-muted ms-1">(' + escapeHtml(temp.celsius) + '°C)</small>' : '')
      + '</div></div></div>'
      + '<div class="col-md-6"><div class="info-box"><span class="info-label">Model</span><div class="info-value">'
      + escapeHtml(route.model || '-') + '</div></div></div>'
      + '<div class="col-md-12"><div class="info-box"><span class="info-label">CPU Distribution</span>'
      + '<div class="progress" style="height: 10px;">'
      + '<div class="progress-bar bg-primary" style="width:' + userP + '%"></div>'
      + '<div class="progress-bar bg-info" style="width:' + sysP + '%"></div>'
      + '<div class="progress-bar bg-secondary" style="width:' + idleP + '%"></div>'
      + '</div>'
      + '<div class="small text-muted mt-2">User ' + userP + '% • System ' + sysP + '% • Idle ' + idleP + '%</div>'
      + '</div></div>'
      + '<div class="col-md-6"><div class="info-box"><span class="info-label">Load Average</span>'
      + '<div class="d-flex flex-wrap gap-2">'
      + '<span class="route-chip">1m ' + escapeHtml(load.one || '0') + '</span>'
      + '<span class="route-chip">5m ' + escapeHtml(load.five || '0') + '</span>'
      + '<span class="route-chip">15m ' + escapeHtml(load.fifteen || '0') + '</span>'
      + '</div></div></div>'
      + '<div class="col-md-6"><div class="info-box"><span class="info-label">Memory</span>'
      + '<div class="info-value mb-1">DRAM ' + escapeHtml(memory.dram || '-') + ' <span class="text-muted">/ ' + escapeHtml(memory.installed || '-') + '</span></div>'
      + '<div class="progress" style="height: 6px;"><div class="progress-bar" style="width:' + buf + '%"></div></div>'
      + '<small class="text-muted">Buffer Utilization ' + buf + '%</small>'
      + '</div></div>'
      + '<div class="col-md-12"><div class="info-box"><span class="info-label">Uptime</span>'
      + '<div class="info-value mb-1">' + escapeHtml(uptime.up_time || '-') + '</div>'
      + (uptime.start_time ? '<small class="text-muted d-block">Since ' + escapeHtml(uptime.start_time) + '</small>' : '')
      + (uptime.last_reboot_reason ? '<small class="text-muted d-block">Last reboot: ' + escapeHtml(uptime.last_reboot_reason) + '</small>' : '')
      + '</div></div>'
      + '</div>';

    routeContent.innerHTML = html;
    hide(routeSkeleton);
    hide(routeError);
    show(routeContent);
  }

  function requestStatus(){
    if (!statusEndpoint) {
      return Promise.reject(new Error('Status endpoint tidak tersedia'));
    }
    if (window.fetch){
      return fetch(statusEndpoint, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' })
        .then(function(response){
          if (!response.ok) throw new Error('HTTP ' + response.status);
          return response.json();
        });
    }
    return new Promise(function(resolve, reject){
      var xhr = new XMLHttpRequest();
      xhr.open('GET', statusEndpoint, true);
      xhr.withCredentials = true;
      xhr.setRequestHeader('Accept', 'application/json');
      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4){
          if (xhr.status >= 200 && xhr.status < 300){
            try {
              resolve(JSON.parse(xhr.responseText || '{}'));
            } catch (err) {
              reject(err);
            }
          } else {
            reject(new Error('HTTP ' + xhr.status));
          }
        }
      };
      xhr.onerror = function(){ reject(new Error('Network error')); };
      xhr.send();
    });
  }

  function loadStatus(){
    if (!statusEndpoint) {
      console.warn('Status endpoint tidak tersedia.');
      return;
    }
    setSystemLoading();
    setRouteLoading();
    if (btnRefresh){
      btnRefresh.disabled = true;
      btnRefresh.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Memuat...';
    }

    function finalize(){
      if (btnRefresh){
        btnRefresh.disabled = false;
        btnRefresh.innerHTML = '<span class="me-1"><i class="fas fa-rotate"></i></span>Muat ulang data';
      }
    }

    requestStatus()
      .then(function(data){
        if (data.success){
          renderSystem(data.system);
          renderRoute(data.route_engine);
        } else {
          setSystemError(data.message);
          setRouteError(data.message);
        }
        finalize();
      })
      .catch(function(err){
        console.error('Gagal memuat status device', err);
        setSystemError('Gagal memuat data: ' + err);
        setRouteError('Gagal memuat data: ' + err);
        finalize();
      });
  }

  if (btnRefresh){
    btnRefresh.addEventListener('click', function(e){
      e.preventDefault();
      loadStatus();
    });
  }

  loadStatus();
});
</script>
{% endblock %}
