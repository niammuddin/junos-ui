{% extends "base.html" %}

{% block title %}Status {{ device.name }}{% endblock %}

{% block content %}
<style>
  /* Subtle polish */
  .page-title { letter-spacing: .2px; }
  .card { border-radius: 1rem; }
  .card-header {
    border-top-left-radius: 1rem !important;
    border-top-right-radius: 1rem !important;
    background: linear-gradient(135deg, var(--bs-primary), #3b82f6);
  }
  .table-borderless th { color: var(--bs-gray-600); font-weight: 600; }
  .stat-badge { font-size: .75rem; }
  .keyline { border-top: 1px dashed var(--bs-gray-300); }
  .chip { display: inline-flex; align-items: center; gap:.35rem; padding:.35rem .6rem; border-radius: 999px; background: var(--bs-gray-100); font-size:.8rem; }
  .dim { color: var(--bs-gray-600); }
  .btn-icon { display:inline-flex; align-items:center; gap:.5rem; }
  /* Skeletons for loading states */
  .skeleton { position:relative; overflow:hidden; background: #eef2f4; border-radius:.5rem; }
  .skeleton::after { content:""; position:absolute; inset:0; transform:translateX(-100%);
    background: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,.6) 50%, rgba(255,255,255,0) 100%);
    animation: shimmer 1.4s infinite; }
  @keyframes shimmer { 100% { transform:translateX(100%); } }
</style>

<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
  <div class="d-flex align-items-center gap-2">
    <h2 class="page-title mb-0"><i class="fas fa-chart-bar me-2"></i>Status Device: {{ device.name }}</h2>
    <span class="chip" title="IP Address"><i class="fas fa-network-wired"></i>{{ device.ip_address }}</span>
    {% if sys_data and sys_data.model %}<span class="chip" title="Model"><i class="fas fa-microchip"></i>{{ sys_data.model }}</span>{% endif %}
    {% if sys_data and sys_data.os_version %}<span class="chip" title="Junos / OS Version"><i class="fas fa-code"></i>{{ sys_data.os_version }}</span>{% endif %}
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a href="{{ url_for('juniper.devices') }}" class="btn btn-secondary btn-icon">
      <i class="fas fa-arrow-left"></i><span>Kembali</span>
    </a>
    <a href="" class="btn btn-outline-primary btn-icon" id="btn-refresh" data-bs-toggle="tooltip" data-bs-title="Muat ulang data (HTTP refresh)"><i class="fas fa-rotate"></i><span>Refresh</span></a>
  </div>
</div>

<!-- Summary cards row -->
<div class="row g-4 mb-4">
  <!-- Device Info -->
  <div class="col-xl-4 col-lg-6">
    <div class="card h-100 shadow-sm border-0">
      <div class="card-header text-white"><h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Device Info</h5></div>
      <div class="card-body py-4">
        <table class="table table-sm table-borderless mb-3 align-middle">
          <tr><th width="45%">Nama</th><td>{{ device.name }}</td></tr>
          <tr>
            <th>IP Address</th>
            <td class="d-flex align-items-center gap-2">
              <span id="ip-text">{{ device.ip_address }}</span>
              <button type="button" class="btn btn-light btn-sm" data-copy="#ip-text" data-bs-toggle="tooltip" data-bs-title="Salin IP">
                <i class="fas fa-copy"></i>
              </button>
            </td>
          </tr>
          <tr><th>REST API Port</th><td>{{ device.api_port or '-' }}</td></tr>
          <tr>
            <th>REST API</th>
            <td>
              {{ 'HTTPS' if device.api_use_ssl else 'HTTP' }}
              {% if device.api_use_ssl and not device.api_verify_ssl %}
                <span class="badge bg-warning text-dark stat-badge ms-1">Skip verify</span>
              {% elif device.api_use_ssl and device.api_verify_ssl %}
                <span class="badge bg-success stat-badge ms-1">Verified</span>
              {% elif not device.api_use_ssl %}
                <span class="badge bg-danger stat-badge ms-1">Unsecured</span>
              {% endif %}
            </td>
          </tr>
          <tr><th>gNMI Port</th><td>{{ device.gnmi_port or 9339 }}</td></tr>
          <tr>
            <th>gNMI Security</th>
            <td>
              {% if not device.gnmi_use_ssl %}
                Insecure <span class="badge bg-danger stat-badge ms-1">Plaintext</span>
              {% else %}
                TLS
                {% if device.gnmi_use_ssl and not device.gnmi_verify_ssl %}
                  <span class="badge bg-warning text-dark stat-badge ms-1">Skip verify</span>
                {% else %}
                  <span class="badge bg-success stat-badge ms-1">Verified</span>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          <tr>
            <th>Username</th>
            <td class="d-flex align-items-center gap-2">
              <span id="user-text">{{ device.username }}</span>
              <button type="button" class="btn btn-light btn-sm" data-copy="#user-text" data-bs-toggle="tooltip" data-bs-title="Salin username">
                <i class="fas fa-copy"></i>
              </button>
            </td>
          </tr>
          <tr><th>Description</th><td>{{ device.description or '-' }}</td></tr>
        </table>
        <!-- <div class=" pt-3">
          <div class="dim small">ID Perangkat: <code>{{ device.id }}</code></div>
        </div> -->
      </div>
    </div>
  </div>

  <!-- System Information -->
  <div class="col-xl-4 col-lg-6">
    <div class="card h-100 shadow-sm border-0">
      <div class="card-header text-white"><h5 class="card-title mb-0"><i class="fas fa-desktop me-2"></i>System Information</h5></div>
      <div class="card-body py-4">
        {% if sys_data %}
          <table class="table table-sm table-borderless mb-0">
            <tr><th width="45%">Hostname</th><td>{{ sys_data.hostname }}</td></tr>
            <tr><th>Model</th><td>{{ sys_data.model }}</td></tr>
            <tr><th>OS Version</th><td>{{ sys_data.os_version }}</td></tr>
            <tr><th>Serial Number</th><td>{{ sys_data.serial_number }}</td></tr>
          </table>
        {% elif sys_error %}
          <div class="alert alert-danger mb-0">
            <i class="fas fa-exclamation-triangle me-1"></i>{{ sys_error }}
          </div>
        {% else %}
          <div class="skeleton" style="height: 112px;"></div>
          <div class="dim small mt-2"><i class="fas fa-sync-alt fa-spin me-1"></i>Memuat system information…</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Route Engine -->
  <div class="col-xl-4 col-lg-12">
    <div class="card h-100 shadow-sm border-0">
      <div class="card-header text-white"><h5 class="card-title mb-0"><i class="fas fa-server me-2"></i>Route Engine</h5></div>
      <div class="card-body py-4">
        {% if re_data %}
          {% set re_status = (re_data.status|lower if re_data.status else '') %}
          {% set status_color = 'success' if 'ok' in re_status or 'online' in re_status else ('warning' if 'degrad' in re_status else 'danger') %}
          <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
            <span class="badge bg-{{ status_color }} stat-badge"><i class="fas fa-circle me-1"></i>{{ re_data.status }}</span>
            {% if re_data.uptime and re_data.uptime.up_time %}
              <span class="chip" title="Up Time"><i class="fas fa-clock"></i>{{ re_data.uptime.up_time }}</span>
            {% endif %}
          </div>

          <table class="table table-sm table-borderless mb-3">
            <tr><th width="45%">Model</th><td>{{ re_data.model }}</td></tr>
            <tr>
              <th>Temperature</th>
              <td>
                {% set t = (re_data.temperature.celsius | float) if re_data.temperature and (re_data.temperature.celsius is not none) else none %}
                {% set t_class = 'text-success' if (t is number and t < 65) else ('text-warning' if (t is number and t < 80) else 'text-danger') %}
                <span class="{{ t_class }}">{{ re_data.temperature.text }}</span>
                {% if t is not none %}<span class="text-muted">({{ t }}°C)</span>{% endif %}
              </td>
            </tr>
            <tr>
              <th>CPU Usage</th>
              <td>
                {% set userp = re_data.cpu.user or 0 %}
                {% set sysp  = re_data.cpu.system or 0 %}
                {% set idlep = re_data.cpu.idle or 0 %}
                <div class="progress" style="height: 10px;">
                  <div class="progress-bar" role="progressbar" style="width: {{ userp }}%" aria-label="User {{ userp }}%" title="User {{ userp }}%"></div>
                  <div class="progress-bar" role="progressbar" style="width: {{ sysp }}%" aria-label="System {{ sysp }}%" title="System {{ sysp }}%"></div>
                  <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ idlep }}%" aria-label="Idle {{ idlep }}%" title="Idle {{ idlep }}%"></div>
                </div>
                <div class="small dim mt-1">User {{ userp }}% • System {{ sysp }}% • Idle {{ idlep }}%</div>
              </td>
            </tr>
            <tr>
              <th>Load Average</th>
              <td>
                <span class="chip" title="1 min">1m {{ re_data.cpu.load_average.one }}</span>
                <span class="chip" title="5 min">5m {{ re_data.cpu.load_average.five }}</span>
                <span class="chip" title="15 min">15m {{ re_data.cpu.load_average.fifteen }}</span>
              </td>
            </tr>
            <tr>
              <th>Memory</th>
              <td>
                {% set buf = re_data.memory.buffer_utilization or 0 %}
                <div class="mb-1">DRAM {{ re_data.memory.dram }} <span class="dim">/ Installed {{ re_data.memory.installed }}</span></div>
                <div class="small dim">Buffer Utilization {{ buf }}%</div>
                <div class="progress" style="height: 8px;">
                  <div class="progress-bar" role="progressbar" style="width: {{ buf }}%" aria-valuenow="{{ buf }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </td>
            </tr>
            <tr>
              <th>Uptime</th>
              <td>
                {{ re_data.uptime.up_time }}<br>
                {% if re_data.uptime.start_time %}<small class="text-muted">Since {{ re_data.uptime.start_time }}</small><br>{% endif %}
                {% if re_data.uptime.last_reboot_reason %}<small class="text-muted">Last reboot: {{ re_data.uptime.last_reboot_reason }}</small>{% endif %}
              </td>
            </tr>
          </table>
        {% elif re_error %}
          <div class="alert alert-warning mb-0">
            <i class="fas fa-exclamation-triangle me-1"></i>{{ re_error }}
          </div>
        {% else %}
          <div class="skeleton" style="height: 180px;"></div>
          <div class="dim small mt-2"><i class="fas fa-sync-alt fa-spin me-1"></i>Memuat route engine…</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Navigation Buttons -->
<div class="d-flex flex-wrap gap-2 mb-4">
  <div class="btn-group" role="group" aria-label="Navigasi">
    <a href="{{ url_for('juniper.policy_options', device_id=device.id) }}" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-title="Policy Options">
      <i class="fas fa-cogs me-1"></i>Policy Options
    </a>
    <a href="{{ url_for('juniper.device_bgp_summary', device_id=device.id) }}" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-title="Ringkasan BGP">
      <i class="fas fa-project-diagram me-1"></i>BGP Summary
    </a>
    <a href="{{ url_for('juniper.static_routes', device_id=device.id) }}" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-title="Static Routes">
      <i class="fas fa-route me-1"></i>Static Routes
    </a>
    <a href="{{ url_for('juniper.interfaces', device_id=device.id) }}" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-title="Daftar Interfaces">
      <i class="fas fa-network-wired me-1"></i>View Interfaces
    </a>
    <a href="{{ url_for('juniper.interface_traffic', device_id=device.id) }}" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-title="Streaming Telemetry">
      <i class="fas fa-tachometer-alt me-1"></i>Live Traffic
    </a>
  </div>
</div>

{% if not re_data and re_error %}
  <div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i> Tidak dapat mengambil Route Engine info: {{ re_error }}
  </div>
{% endif %}

<script>
  // Enable Bootstrap tooltips
  (function(){
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl);
    });
  })();

  // Simple refresh
  document.getElementById('btn-refresh')?.addEventListener('click', function(e){ e.preventDefault(); location.reload(); });

  // Copy helpers
  document.querySelectorAll('[data-copy]').forEach(function(btn){
    btn.addEventListener('click', function(){
      var sel = this.getAttribute('data-copy');
      var el = document.querySelector(sel);
      if (!el) return;
      var text = (el.innerText || el.textContent || '').trim();
      if (!text) return;
      navigator.clipboard.writeText(text).then(()=>{
        this.innerHTML = '<i class="fas fa-check"></i>';
        this.classList.remove('btn-light');
        this.classList.add('btn-success');
        setTimeout(()=>{
          this.innerHTML = '<i class="fas fa-copy"></i>';
          this.classList.remove('btn-success');
          this.classList.add('btn-light');
        }, 900);
      });
    });
  });
</script>
{% endblock %}
